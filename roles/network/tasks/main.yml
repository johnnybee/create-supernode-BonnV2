---
# tasks file for network
- name: install packages
  apt:
    name:
      - iproute2
      - uml-utilities
    state: latest
    update_cache: yes

- name: extend /etc/iproute2/rt_tables
  lineinfile:
    path: /etc/iproute2/rt_tables
    state: present
    regexp: '^90\s'
    line: '90 freifunk'

- name: configure /etc/network/interfaces.d/br-ffintern
  template:
    src: "br-ffintern.j2"
    dest: /etc/network/interfaces.d/br-ffintern
    owner: root
    group: root
    mode: 0644

- name: Remove "resolvconf" package
  apt:
    name: resolvconf
    state: absent

- name: configure /etc/network/interfaces
  template:
    src: "interfaces.j2"
    dest: /etc/network/interfaces
    owner: root
    group: root
    mode: 0644

- name: change /etc/resolv.conf
  copy:
    src: "etc/resolv.conf"
    dest: "/etc/resolv.conf"
    owner: root
    group: root
    mode: 0644

- name: change net.ipv4.ip_forward
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: yes
    state: present
    reload: yes
  with_items:
    - { name: 'net.ipv4.ip_forward', value: 1 }
    - { name: 'net.ipv4.ip_no_pmtu_disc', value: 1 }
    - { name: 'net.ipv4.route.flush', value: 1 }
    - { name: 'net.ipv6.conf.all.forwarding', value: 1 }
    - { name: 'net.ipv6.conf.all.autoconf', value: 0 }
    - { name: 'net.ipv6.conf.all.accept_ra', value: 0 }
    - { name: 'net.core.rmem_max', value: 83886080 }
    - { name: 'net.core.wmem_max', value: 83886080 }
    - { name: 'net.core.rmem_default', value: 83886080 }
    - { name: 'net.core.wmem_default', value: 83886080 }
    - { name: 'net.netfilter.nf_conntrack_tcp_timeout_established', value: 86400 }
    - { name: 'net.netfilter.nf_conntrack_max', value: 262140 }
    - { name: 'kernel.panic', value: 10 }
    - { name: 'fs.file-max', value: 149219 }

- name: Extend noproc soft limit for normal users
  pam_limits:
    domain: "{{ item.domain }}"
    limit_type: "{{ item.limit_type }}"
    limit_item: "{{ item.limit_item }}"
    value: 65535
  with_items:
    - { domain: '*', limit_type: 'soft', limit_item: 'nproc' }
    - { domain: '*', limit_type: 'hard', limit_item: 'nproc' }
    - { domain: '*', limit_type: 'soft', limit_item: 'nofile' }
    - { domain: '*', limit_type: 'hard', limit_item: 'nofile' }
    - { domain: 'root', limit_type: 'soft', limit_item: 'nproc' }
    - { domain: 'root', limit_type: 'hard', limit_item: 'nproc' }
    - { domain: 'root', limit_type: 'soft', limit_item: 'nofile' }
    - { domain: 'root', limit_type: 'hard', limit_item: 'nofile' }
